/// Generic Audit Logging Models
///
/// The AuditLog model provides a generic and extensible system for tracking significant events
/// and changes across the entire application. It is designed to be used by various modules,
/// including Admin, Team, User, and System, to ensure accountability and traceability.
model AuditLog {
  id            String        @id @default(ulid())
  /// The specific action that was performed (e.g., USER_CREATED, TEAM_UPDATED).
  action        String
  /// The severity level of the event (e.g., INFO, WARNING, CRITICAL).
  severity      AuditSeverity @default(INFO)
  /// A high-level category for the event (e.g., USER_MANAGEMENT, SECURITY).
  category      AuditCategory
  /// The application module where the event originated (e.g., ADMIN, TEAM).
  module        AuditModule
  /// A human-readable description of the event.
  description   String
  /// The number of days this log entry should be retained. Null means forever.
  retentionDays Int?
  /// A JSON object for storing additional, unstructured context about the event.
  metadata      Json? // Additional context data
  /// The IP address from which the action was initiated.
  ipAddress     String?
  /// The user agent string of the client that initiated the action.
  userAgent     String?

  // Timestamps
  createdAt DateTime @default(now())

  // Actor (who performed the action)
  /// The user who performed the action. Can be null for system-generated events.
  actorId String?
  actor   User?   @relation(fields: [actorId], references: [id], onDelete: SetNull)

  // Generic entity tracking
  /// The type of the primary entity affected by the action (e.g., "user", "team", "system").
  entityType String
  /// The unique identifier of the primary entity affected.
  entityId   String? // ID of the affected entity

  // Audit details
  /// A list of detailed changes associated with this log entry (e.g., field-level updates).
  auditDetails AuditLogDetail[]

  @@index([module])
  @@index([action])
  @@index([category])
  @@index([actorId])
  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
  @@index([module, createdAt])
}

/// Identifies the application module from which an audit log event originated.
enum AuditModule {
  ADMIN
  TEAM
  SYSTEM
  USER
  BILLING
  SECURITY
}

/// Defines the severity level of an audit log event.
enum AuditSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

/// A high-level categorization of audit log events.
enum AuditCategory {
  TEAM_MANAGEMENT
  ADMIN_MANAGEMENT
  USER_MANAGEMENT
  LEARNING_MANAGEMENT
  SECURITY
  BILLING
  DATA_MANAGEMENT
  INTEGRATIONS
  SETTINGS
  SYSTEM
  MAINTENANCE
}

/// Records the fine-grained details of a change, such as the modification of a single field.
/// Each AuditLog entry can have multiple AuditLogDetail entries.
model AuditLogDetail {
  id         String     @id @default(ulid())
  /// The name of the field that was changed.
  field      String // Name of the field that changed
  /// The value of the field before the change.
  oldValue   String? // Previous value
  /// The value of the field after the change.
  newValue   String? // New value
  /// The type of change that occurred (e.g., CREATED, UPDATED, DELETED).
  changeType ChangeType

  // Relations
  auditLogId String
  auditLog   AuditLog @relation(fields: [auditLogId], references: [id], onDelete: Cascade)

  @@index([auditLogId])
  @@index([field])
}

/// The type of change that occurred in an AuditLogDetail.
enum ChangeType {
  CREATED
  UPDATED
  DELETED
  ADDED
  REMOVED
  ENABLED
  DISABLED
  ACTIVATED
  DEACTIVATED
  CHANGED
  SET
  CLEARED
}

/// Represents a request to export a set of audit logs, typically for compliance or analysis.
model AuditLogExport {
  id          String       @id @default(ulid())
  /// The name of the generated export file.
  fileName    String
  /// The size of the export file in bytes.
  fileSize    Int
  /// The format of the export (e.g., CSV, JSON, PDF).
  format      ExportFormat
  /// The current status of the export process.
  status      ExportStatus @default(PENDING)
  /// The URL from which the export file can be downloaded.
  downloadUrl String?
  /// The timestamp when the download URL expires.
  expiresAt   DateTime?

  // Filter criteria
  /// The start date for the logs to be included in the export.
  startDate  DateTime?
  /// The end date for the logs to be included in the export.
  endDate    DateTime?
  /// A JSON array of AuditModule values to filter the export.
  modules    Json? // Array of AuditModule values as JSON
  /// A JSON array of AuditAction values to filter the export.
  actions    Json? // Array of AuditAction values as JSON
  /// A JSON array of AuditCategory values to filter the export.
  categories Json? // Array of AuditCategory values as JSON

  // Relations
  /// The team for which the export was generated. Can be null for system-wide exports.
  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  /// The user who requested the export.
  requestedById String
  requestedBy   User   @relation(fields: [requestedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([status])
  @@index([requestedById])
  @@index([createdAt])
}

/// The file format for an audit log export.
enum ExportFormat {
  CSV
  JSON
  PDF
  EXCEL
}

/// The status of an audit log export process.
enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  EXPIRED
}
